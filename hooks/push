#!/bin/bash
set -eu

echo "ğŸ”µ push"
source hooks/.config

# 1. push all images
DOCKER_REPO="${DOCKER_REPO//index.docker.io\/}"

for arch in ${build_architectures[@]}; do
  echo "âœ… Pushing ${DOCKER_REPO}:${DOCKER_TAG}-${arch}"
  echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"
  echo
  docker push ${DOCKER_REPO}:${DOCKER_TAG}-${arch}

  echo "âœ… Pushing ${DOCKER_REPO}:latest-${arch}"
  echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"
  echo
  docker tag ${DOCKER_REPO}:${DOCKER_TAG}-${arch} ${DOCKER_REPO}:latest-${arch}
  docker push ${DOCKER_REPO}:latest-${arch}
done


TAGS=(${DOCKER_TAG} latest)
for CURRENT_TAG in ${TAGS[@]}; do

  # 2. build and push manifest
  DOCKER_REPO="index.docker.io/${DOCKER_REPO}"
  manifests=""

  for arch in ${build_architectures[@]}; do
    manifests="${manifests} ${DOCKER_REPO}:${CURRENT_TAG}-${arch}"
  done

  echo "âœ… Creating manifest ${DOCKER_REPO}:${CURRENT_TAG}"
  echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"
  docker manifest create ${DOCKER_REPO}:${CURRENT_TAG} \
                              $manifests
  echo

  echo "âœ… Annotating manifest"
  echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"
  for arch in ${build_architectures[@]}; do
      docker manifest annotate ${DOCKER_REPO}:${CURRENT_TAG} \
      ${DOCKER_REPO}:${CURRENT_TAG}-${arch} \
      --os linux \
      --arch ${docker_to_manifest_map[${arch}]}
  done

  echo "âœ… Inspecting manifest ${DOCKER_REPO}:${CURRENT_TAG}"
  echo "â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯"
  docker manifest inspect ${DOCKER_REPO}:${CURRENT_TAG}
  echo
done

echo
echo "ğŸ˜Š"